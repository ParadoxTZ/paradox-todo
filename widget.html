<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paradox's TODO</title>
  <style>
    :root {
      --cream: #FDF8F3;
      --sand: #F5EDE4;
      --sage: #87A878;
      --sage-dark: #5C7A4D;
      --terra: #C9A77C;
      --rose: #E8A9A9;
      --priority-high: #D95D5D;
      --priority-medium: #E8A94E;
      --priority-low: #6B9E6D;
      --charcoal: #3D3D3D;
      --text-muted: #7A7A7A;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--cream);
      color: var(--charcoal);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 12px 16px;
      background: linear-gradient(135deg, var(--sage), var(--sage-dark));
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      -webkit-app-region: drag;
    }

    .title {
      font-weight: 600;
      font-size: 14px;
    }

    .add-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-app-region: no-drag;
      transition: background 0.2s;
    }

    .add-btn:hover { background: rgba(255,255,255,0.3); }

    .pin-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-app-region: no-drag;
      transition: background 0.2s;
    }

    .pin-btn:hover { background: rgba(255,255,255,0.3); }
    .pin-btn.pinned { background: rgba(255,255,255,0.9); color: var(--sage-dark); }

    .task-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .task-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: white;
      border-radius: 12px;
      margin-bottom: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      transition: all 0.2s;
    }

    .task-item:hover {
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .task-item.completed {
      opacity: 0.5;
      background: var(--sand);
    }

    .task-item.completed .task-text {
      text-decoration: line-through;
    }

    .priority-dot {
      width: 4px;
      height: 32px;
      border-radius: 2px;
      flex-shrink: 0;
    }

    .priority-dot.high { background: var(--priority-high); }
    .priority-dot.medium { background: var(--priority-medium); }
    .priority-dot.low { background: var(--priority-low); }

    .checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid var(--sage);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .checkbox.checked {
      background: var(--sage);
    }

    .checkbox.checked::after {
      content: 'âœ“';
      color: white;
      font-size: 12px;
    }

    .task-content { flex: 1; min-width: 0; }

    .task-text {
      font-size: 13px;
      word-break: break-word;
    }

    .task-due {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .task-due.overdue { color: var(--priority-high); }
    .task-due.urgent { color: var(--priority-medium); }

    .task-location {
      font-size: 11px;
      color: var(--sage-dark);
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .delete-btn {
      opacity: 0;
      background: none;
      border: none;
      color: var(--priority-high);
      cursor: pointer;
      padding: 4px;
      font-size: 16px;
      transition: opacity 0.2s;
    }

    .task-item:hover .delete-btn { opacity: 1; }

    .empty-state {
      text-align: center;
      color: var(--text-muted);
      padding: 40px 20px;
      font-size: 13px;
    }

    .stats {
      padding: 8px 16px;
      background: white;
      border-top: 1px solid var(--sand);
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
    }
  </style>
</head>
<body>
  <div class="header">
    <span class="title">Paradox's TODO</span>
    <div style="display: flex; gap: 8px;">
      <button class="pin-btn" id="pinBtn" onclick="togglePin()" title="ç‚¹å‡»ç½®é¡¶">ğŸ“Œ</button>
      <button class="add-btn" onclick="openAddWindow()">+</button>
    </div>
  </div>
  <div class="task-list" id="taskList"></div>
  <div class="stats" id="stats"></div>

  <script>
    async function loadTasks() {
      try {
        const tasks = await window.api.getTasks();
        renderTasks(tasks);
      } catch (e) {
        // é™çº§ä½¿ç”¨localStorage
        const tasks = JSON.parse(localStorage.getItem('paradoxTodoTasks') || '[]');
        renderTasks(tasks);
      }
    }

    function renderTasks(tasks) {
      const list = document.getElementById('taskList');
      const stats = document.getElementById('stats');

      if (tasks.length === 0) {
        list.innerHTML = '<div class="empty-state">æš‚æ— å¾…åŠäº‹é¡¹<br>ç‚¹å‡»+æ·»åŠ ä»»åŠ¡</div>';
        stats.textContent = '0/0';
        return;
      }

      list.innerHTML = tasks.map(task => `
        <div class="task-item ${task.completed ? 'completed' : ''}" data-id="${task.id}">
          <div class="priority-dot ${task.priority}"></div>
          <div class="checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask(${task.id})"></div>
          <div class="task-content">
            <div class="task-text">${escapeHtml(task.text)}</div>
            ${task.dueDate ? `<div class="task-due ${getDueClass(task.dueDate)}">ğŸ“… ${formatDateDisplay(task.dueDate)} ${task.time ? task.time : ''}</div>` : ''}
            ${task.location ? `<div class="task-location">ğŸ“ ${escapeHtml(task.location)}</div>` : ''}
          </div>
          <button class="delete-btn" onclick="deleteTask(${task.id})">Ã—</button>
        </div>
      `).join('');

      const pending = tasks.filter(t => !t.completed).length;
      stats.textContent = `${pending}/${tasks.length}`;
    }

    function formatDateDisplay(dateStr) {
      if (!dateStr) return '';
      const [year, month, day] = dateStr.split('-');
      const date = new Date(year, month - 1, day);
      const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
      const weekday = weekdays[date.getDay()];
      return `${parseInt(month)}æœˆ${parseInt(day)}æ—¥ ${weekday}`;
    }

    function getDueClass(dateStr) {
      if (!dateStr) return '';
      // å­—ç¬¦ä¸²æ¯”è¾ƒæ—¥æœŸ
      const today = new Date();
      const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

      if (dateStr < todayStr) return 'overdue';
      // åˆ¤æ–­æ˜¯å¦3å¤©å†…
      const todayParts = todayStr.split('-').map(Number);
      const dueParts = dateStr.split('-').map(Number);
      const todayDays = todayParts[0] * 365 + (todayParts[1] - 1) * 30 + todayParts[2];
      const dueDays = dueParts[0] * 365 + (dueParts[1] - 1) * 30 + dueParts[2];
      if (dueDays - todayDays <= 2) return 'urgent';
      return '';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function toggleTask(id) {
      try {
        await window.api.toggleTask(id);
        // ç«‹å³åˆ·æ–°è§†å›¾
        loadTasks();
      } catch (e) {
        // é™çº§
        const tasks = JSON.parse(localStorage.getItem('paradoxTodoTasks') || '[]');
        const task = tasks.find(t => t.id === id);
        if (task) {
          task.completed = !task.completed;
          localStorage.setItem('paradoxTodoTasks', JSON.stringify(tasks));
          loadTasks();
        }
      }
    }

    async function deleteTask(id) {
      try {
        await window.api.deleteTask(id);
      } catch (e) {
        const tasks = JSON.parse(localStorage.getItem('paradoxTodoTasks') || '[]');
        const filtered = tasks.filter(t => t.id !== id);
        localStorage.setItem('paradoxTodoTasks', JSON.stringify(filtered));
        loadTasks();
      }
    }

    async function openAddWindow() {
      if (window.api.openAddWindow) {
        await window.api.openAddWindow();
      }
    }

    async function minimizeToTray() {
      if (window.api.minimizeWidget) {
        await window.api.minimizeWidget();
      }
    }

    async function togglePin() {
      if (window.api.toggleAlwaysOnTop) {
        const isPinned = await window.api.toggleAlwaysOnTop();
        const pinBtn = document.getElementById('pinBtn');
        pinBtn.classList.toggle('pinned', isPinned);
        pinBtn.style.background = isPinned ? 'rgba(255,255,255,0.9)' : '';
        pinBtn.style.color = isPinned ? 'var(--sage-dark)' : '';
      }
    }

    // åˆå§‹åŒ–ç½®é¡¶çŠ¶æ€
    async function initPinState() {
      if (window.api.getAlwaysOnTop) {
        const isPinned = await window.api.getAlwaysOnTop();
        const pinBtn = document.getElementById('pinBtn');
        if (isPinned) {
          pinBtn.classList.add('pinned');
          pinBtn.style.background = 'rgba(255,255,255,0.9)';
          pinBtn.style.color = 'var(--sage-dark)';
        }
      }
    }

    // ç›‘å¬ä»»åŠ¡æ›´æ–°
    if (window.api.onTasksUpdated) {
      window.api.onTasksUpdated((tasks) => {
        renderTasks(tasks);
      });
    }

    // çª—å£æ˜¾ç¤ºæ—¶åˆ·æ–°æ•°æ®
    window.addEventListener('focus', loadTasks);

    loadTasks();
    initPinState();
  </script>
</body>
</html>
